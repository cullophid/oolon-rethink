// Generated by CoffeeScript 1.10.0
(function() {
  var curry, getConnectionOptions, merge, parse, ref, rethink, split, tail;

  rethink = require('rethinkdb');

  ref = require('ramda'), split = ref.split, merge = ref.merge, curry = ref.curry, tail = ref.tail;

  parse = require('url').parse;

  getConnectionOptions = (function(_this) {
    return function(url) {
      var auth, hostname, options, password, path, port, ref1, ref2, user;
      ref1 = parse(url), hostname = ref1.hostname, port = ref1.port, path = ref1.path, auth = ref1.auth;
      options = {
        host: hostname,
        port: port,
        db: (tail(path)) || 'test'
      };
      if (auth) {
        ref2 = split(':', auth), user = ref2[0], password = ref2[1];
        return merge(options, {
          user: user,
          password: password
        });
      } else {
        return options;
      }
    };
  })(this);

  module.exports = (function(_this) {
    return function(url) {
      var _run, connect, options;
      options = getConnectionOptions(url);
      console.log('OPTIONs', options);
      connect = function(options) {
        return rethink.connect(options);
      };
      _run = function(query) {
        return connect(options).then(function(conn) {
          return query.run(conn).then(function(res) {
            conn.close();
            return res;
          });
        });
      };
      return {
        run: _run,
        toArray: function(query) {
          return _run(query).then(function(cur) {
            return cur.toArray();
          });
        },
        each: curry(function(fn, query) {
          return _run(query).then(function(cur) {
            return cur.each(fn);
          });
        }),
        eachAsync: curry(function(fn, query) {
          return _run(query).then(function(cur) {
            return cur.eachAsync(fn);
          });
        })
      };
    };
  })(this);

}).call(this);
